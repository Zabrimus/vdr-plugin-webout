<!DOCTYPE HTML>
<html>
<head>
    <title>Test</title>

    <link href="/video-js.css" rel="stylesheet">

    <style>
        body {
            margin:0;
            padding:0;
        }

        #video {
            position: relative;
        }

        #osdCanvas {
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
        }

        #container {
            position: relative;
        }
    </style>


    <!-- Websocket Connection -->
    <script type="text/javascript" charset="utf-8">
        let osdSocket = new WebSocket("ws://localhost:3000/command");
        osdSocket.binaryType = "arraybuffer";

        osdSocket.onopen = function(e) {
            console.log("[open] Connection established");
        };

        osdSocket.onmessage = function(event) {
            let dv = new DataView(event.data, 0);
            let type = dv.getInt32(0, true);

            console.log("Message received...");

            switch(type) {
                case 1: // show PNG Image
                    console.log("PNG Image received");
                    drawImage("osdCanvas", event.data);
                    break;

                case 2: // set Size
                    console.log("Size received");
                    // setCanvasVideoSize("osdCanvas", event.data);
                    // setCanvasVideoSize("video", event.data);
                    // setCanvasVideoSize("container", event.data);
                    break;
            }
        };

        osdSocket.onclose = function(event) {
            if (event.wasClean) {
                console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
            } else {
                // e.g. server process killed or network down
                // event.code is usually 1006 in this case
                console.log('[close] Connection died');
            }
        };

        osdSocket.onerror = function(error) {
            console.log(`[error] ${error.message}`);
        };
    </script>

    <!-- key events send to VDR -->
    <script type="text/javascript" charset="utf-8">
        window.addEventListener(
            "keydown",
            (evt) => {
                let shift = evt.shiftKey ? "1" : "0";
                let alt = evt.altKey ? "1" : "0";
                let ctrl = evt.ctrlKey ? "1" : "0";
                let meta = evt.metaKey ? "1" : "0";

                console.log("Key Code: " + evt.code);

                let buffer = new TextEncoder().encode("3:" + shift + alt + ctrl + meta + ":" + evt.code).buffer;
                osdSocket.send(buffer);

                evt.preventDefault();
                evt.stopPropagation();
            }
        )
    </script>

    <!-- draw png image on canvas -->
    <script type="text/javascript" charset="utf-8">
        function drawImage(canvas, buffer) {
            let dv = new DataView(buffer, 0)

            let osdWidth = dv.getInt32(4, true);
            let osdHeight = dv.getInt32(8, true);
            let x = dv.getInt32(12, true);
            let y = dv.getInt32(16, true);
            let w = dv.getInt32(20, true);
            let h = dv.getInt32(24, true);

            let png = new Blob([buffer.slice(28)], {type: "image/png"});
            let img = new Image();
            img.src = URL.createObjectURL(png);
            let canvasElement = document.getElementById(canvas);
            let ctx = canvasElement.getContext("2d");

            img.onload = function() {
                // scale image width and coordinates
                let canvasWidth = parseInt(canvasElement.getAttribute("width"),10);
                let canvasHeight = parseInt(canvasElement.getAttribute("height"), 10);
                let scale = Math.max(canvasWidth / osdWidth, canvasHeight / osdHeight);

                ctx.clearRect(x*scale, y*scale, w * scale, h * scale);
                ctx.drawImage(img, x*scale, y*scale, w * scale, h * scale);
            }
        }
    </script>

    <!-- set Canvas Size -->
    <script type="text/javascript" charset="utf-8">
        function setCanvasVideoSize(canvas, buffer) {
            let dv = new DataView(buffer, 0)

            let w = dv.getInt32(4, true);
            let h = dv.getInt32(8, true);

            let c = document.getElementById(canvas);
            c.style.width  = w + 'px';
            c.style.height = h + 'px';
        }
    </script>

</head>

<body>
    <div id="container">
        <video-js id="video" preload="auto" style="background-color: yellow"></video-js>
        <canvas id="osdCanvas"></canvas>
    </div>

    <!-- video script -->
    <script src="/video.js"></script>
    <script>
        var player = videojs('video', {
            "liveui": true,
            "fluid": true,
        });

        player.src({
            src: '/stream/vdr-live-tv.m3u8',
            type: 'application/x-mpegURL'
        });

        var bpb = player.getChild('bigPlayButton');
        if (bpb) {
            bpb.hide();

            player.ready(function() {
                var promise = player.play();

                if (promise === undefined) {
                    bpb.show();
                } else {
                    promise.then(function() {
                        bpb.show();
                    }, function() {
                        bpb.show();
                    });
                }
            });
        }
    </script>

    <!-- resize canvas to size of video -->
    <script>
        function resizeCanvas() {
            let osdCanvas = document.getElementById("osdCanvas");
            let video = document.getElementById("video");
            let videoSize = video.getBoundingClientRect();

            osdCanvas.setAttribute("width", videoSize.width.toString() + "px");
            osdCanvas.setAttribute("height", videoSize.height.toString() + "px");
        }

        // initial size
        resizeCanvas();

        // window resize
        window.addEventListener('resize', resizeCanvas());
    </script>
</body>
</html>